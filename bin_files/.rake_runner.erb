#!/usr/bin/env ruby
#
# The application 'rake' is installed as part of a gem, and
# this file is here to facilitate running it.
#

require 'rubygems'

version = ">= 0"

if ARGV.first =~ /^_(.*)_$/ and Gem::Version.correct? $1 then
  version = $1
  ARGV.shift
end

if File.exists?(File.expand_path('../../Gemfile.lock', __FILE__))
  <%
    rake_line = `grep -P "^rake\b \(([^\)]+)\)" Gemfile.lock`.chomp
    rake_line =~ /\((.*)\)/
    detected_rake_version = $1
  %>

  $LOAD_PATH.unshift(File.expand_path("vendor/bundle/jruby/<%= @settings.ruby_version %>/gems/rake-<%= detected_rake_version %>/lib"))
  version = "= <%= detected_rake_version %>"
  loaded = true
  require 'rake'

  # Can't use Gem.bin_path below since rake hasn't been loaded as a gem.
  Rake.application.run
else
  gem 'rake', version
  load Gem.bin_path('rake', 'rake', version)
end
